<html>
<head>
	<title>Jeu stock-car socket - K. Rouland et B. Valthier - Run 1</title>
	<script src="libjs/jquery.min.js"></script>
</head>
<body>
	 
	<div id="gamepadPrompt"></div>
	<canvas id="canvas" width="650" height="650" style="background-color: green;"></canvas>

<script>
var car_images = [];
var initDraw = false; //draw que quand on recoit une voiture    
var dom_canvas = document.getElementById("canvas");
var context = dom_canvas.getContext("2d");
var hasGP = false;
var repGP;

var gameStarted = false;
var random = Math.random() > 0.5;


//les tableaux de valeurs d'init des nouvelles voitures
var colors = ['red', 'green', 'blue', 'pink', 'yellow'];
colors.sort(function(a, b)
{
	return random;
});
var xVoiture = [150, 290, 340, 180, 250];
xVoiture.sort(function(a, b)
{
	return random;
});
var yVoiture = [180, 290, 250, 320, 190];
yVoiture.sort(function(a, b)
{
	return random;
});
var angleVoiture = [315, 175, 225, 145, 270];
angleVoiture.sort(function(a, b)
{
	return random;
});

var voiture = {
	x: xVoiture.shift(),
	width: 40,
	height: 26,
	y: yVoiture.shift(),
	acceleration: 1,
	angle: angleVoiture.shift(),
	color: colors.shift(),
	pseudo: "spectator",
	active: true
};


window.addEventListener("keydown", keypress_handler, false);
window.addEventListener("keyup", keyup_handler, false);

$(window).load(function()
{

    //chargement des fichiers images utilisés pour l'affichage des voitures
    car_src = [ "car_red.png", "car_blue.png", "car_green.png", "car_yellow.png", "car_pink.png" ];
    car_images = [];

    for (var i = 0 ; i < car_src.length; i++) {
    	car_images[car_src[i]] = new Image();
    	car_images[car_src[i]].src = "libjs/"+car_src[i];
    }    

    //fais les calculs toutes les 50ms de collision, et de déplacement de la voiture
    setInterval(function()
	{
		if (gameStarted === true)
		{
			//vérifie si le joueur est actif, et met à jour sa position
			if(voiture.active === true)
			{
				vitesse = 5;

				var xB = voiture.x ;
				var yB = voiture.y ;

				var xA = 325 ; //centre du canvas/cercle
				var yA = 325;
				var distance = Math.sqrt((xB - xA)*(xB - xA) + (yB - yA)*(yB - yA));

				//si on ne colisionne pas, on affiche
				if( distance <= 305) //canvassize/2
				{
					angle = voiture.orientation;
					voiture.x += (vitesse * voiture.acceleration) * Math.cos(Math.PI / 180 * angle);
					voiture.y += (vitesse * voiture.acceleration) * Math.sin(Math.PI / 180 * angle);
				}
				else
				{
					//joueur à perdu, collision au bord
					voiture.active = false;
					gameStarted = false;
				}

				drawScene();
			}
		}
	}, 50);	
});

//dessine l'arene de jeu puis la voiture
function drawScene()
{
	if (gameStarted === true) //si on a appuyé sur un bouton pour lancer le jeu
	{

		context = dom_canvas.getContext("2d");
		context.clearRect(0, 0, 650, 650);
		context.fillStyle="#aaa"; 
		//fond du cercle de jeu
		context.arc(325, 325, 325, 0, 2 * Math.PI);
		context.scale(1,1);
		context.fill();
		
		if (voiture.active === true)
			draw(voiture);
	}
	
}

//fonction qui dessine une voiture avec une image
function draw(voiture)
{
	context.save();
	context.translate(voiture.x, voiture.y);
	context.rotate(Math.PI / 180 * voiture.orientation);

	context.drawImage(car_images["car_"+voiture.color+".png"], -(voiture.width / 2), -(voiture.height / 2));

	context.restore();
}

// Ajout ici GamePad
function canGame() {
    return "getGamepads" in navigator;
}

$(document).ready(function() 
{

    if(canGame()) { //on vérifie si le navigateur est suffisament récent.
        var prompt = "Pour commencer, branchez votre gamepad et appuyez sur un bouton. Ou jouez au clavier en appuyant sur une touche. (Z,Q,S,D)";
        $("#gamepadPrompt").text(prompt);

        $(window).on("gamepadconnected", function() { //rattachement  de l'événement (cf plus bas) à une callback
            hasGP = true; //on garde en mémoire qu'il existe un gamePad
            $("#gamepadPrompt").html("Gamepad branché :)");
            //document.formu.bouton.disabled = false;
            //console.log("connection event");
            repGP = window.setInterval(reportOnGamepad,50);
        });

        $(window).on("gamepaddisconnected", function() {//récupération de l'événement (cf plus bas)
            console.log("disconnection event");
            $("#gamepadPrompt").text(prompt);
            window.clearInterval(repGP);
        });

        //Chrome nécessite un petit interval, Firefox, non, mais cela ne dérange pas.
        var checkGP = window.setInterval(function() {
            //console.log('checkGP');
            if(navigator.getGamepads()[0]) {
                if(!hasGP) $(window).trigger("gamepadconnected"); //déclenchement de l'événement
                window.clearInterval(checkGP);
            }
        }, 500);
    }
});

//envoie les messages de commande du gamepad au server
function reportOnGamepad() 
{
	gameStarted = true; //un bouton actionne le jeu

	var gp = navigator.getGamepads()[0];

	if(gp.buttons[12].pressed) {
		carControl('up');
	} else if(gp.buttons[13].pressed) {
		carControl('down');
	}

	if(gp.buttons[14].pressed) carControl('left');
	if(gp.buttons[15].pressed) carControl('right');
}


//relache le frein ou l'accelerateur lorsque l'on relache le bouton
function keyup_handler(event) {
	if (event.keyCode == 90 || event.keyCode == 83) {
	}
	
	if (event.keyCode == 83){
		carControl('nodown'); //on relache le frein
	}
	
	if (event.keyCode == 90) {
		
		carControl('noup'); //on relache l'accelerateur
	}
}

//gestion du clavier lorsqu'on appuie sur les touches
function keypress_handler(event) {
	gameStarted = true; //un bouton actionne le jeu
	if (event.keyCode == 90) {
		
		carControl('up');
	}
	if (event.keyCode == 83) {
	  
		carControl('down');
	}
	if (event.keyCode == 81) {
		
		carControl('left');
	}
	if (event.keyCode == 68) {
	   
		carControl('right');
	}
}

//si un utilisateur a utilisé son gamepad ou le clavier alors on applique les transformations aux voitures
function carControl(msg)
{
	if (msg != 'down' && msg != 'up') //si l'utilisateur relache le bouton frein/accel
	{
		voiture.acceleration = 1;
	}
	if (msg == 'left')
	{
		voiture.orientation -= 8;
	}
	if (msg == 'right')
	{
		voiture.orientation += 8;
	}
	if (msg == 'down')
	{
		voiture.acceleration = 0.5;
	}
	if (msg == 'up')
	{
		voiture.acceleration = 2;
	}
}
</script>
</body>
</html>